#include <stdio.h>
#include <stdint.h>
#include <math.h>
#include <string.h>

float data[] = {
	22.2, 21.7, 21.7, 21.7, 22.0, 22.0, 21.7, 21.7,
	20.7, 20.5, 20.5, 20.0, 20.0, 20.0, 19.7, 19.7, 19.7, 19.5,
	19.7, 19.2, 19.2, 19.2, 19.7, 19.5, 19.7, 19.2, 19.2, 19.2,
	19.7, 19.5, 19.2, 19.2, 19.5, 19.5, 19.0, 19.7, 19.5, 19.5,
	19.2, 19.7, 19.7, 19.7, 19.7, 19.7, 19.7, 19.7, 19.7, 19.7,
	19.7, 19.7, 19.7, 19.7, 19.7, 19.7, 19.7, 19.7, 20.0, 19.7,
	20.0, 20.2, 20.0, 20.0, 20.2, 20.2, 20.2, 20.0, 20.5, 20.0,
	20.0, 20.5, 20.0, 20.2, 20.5, 20.5, 20.2, 20.5, 20.5, 20.5,
	20.7, 21.0, 20.5, 21.0, 20.7, 21.0, 21.0, 20.7, 20.7, 21.2,
	21.7, 21.5, 21.2, 21.2, 21.5, 21.7, 20.7, 21.2, 21.0, 21.0,
	21.0, 21.0, 21.2, 21.5, 20.7, 21.0, 21.0, 20.7, 21.0, 21.0,
	21.2, 20.7, 21.2, 20.7, 21.2, 21.0, 20.5, 21.0, 21.0, 20.7,
	20.5, 20.5, 20.5, 20.2, 20.0, 20.2, 20.2, 20.0, 20.5, 20.2,
	20.0, 20.0, 20.0, 19.7, 19.7, 19.7, 19.7, 19.2, 19.2, 19.2,
	18.7, 19.0, 19.2, 19.0, 19.0, 18.5, 18.7, 18.7, 18.5, 19.0,
	18.5, 18.7, 19.0, 18.7, 18.7, 18.7, 18.7, 18.7, 18.5, 18.5,
	18.7, 18.2, 18.5, 18.5, 18.7, 18.5, 18.5, 18.5, 18.2, 18.5,
	18.7, 18.0, 18.5, 18.0, 18.5, 18.5, 18.2, 18.2, 18.0, 18.0,
	18.0, 18.2, 18.2, 18.2, 18.2, 18.2, 18.0, 18.0, 18.5, 18.5,
	18.2, 18.2, 18.0, 18.2, 18.2, 18.0, 18.0, 18.2, 18.2, 18.0,
	18.2, 18.0, 18.2, 18.0, 18.0, 18.0, 18.0, 18.2, 18.2, 17.7,
	18.0, 17.7, 18.0, 17.7, 18.5, 18.0, 17.7, 17.7, 17.7, 17.7, 
	18.0, 18.0, 18.0, 17.7, 17.7, 18.0, 18.2, 17.7, 17.5, 18.0,
	18.2, 18.0, 17.7, 17.7, 17.7, 17.7, 17.7, 17.7, 17.7, 18.2,
	18.0, 17.5, 18.0, 17.7, 17.5, 17.7, 17.7, 17.7, 17.2, 18.0,
	18.0, 17.7, 17.7, 18.0, 17.5, 17.7, 17.5, 17.5
};

struct fir {
	float b[9];
	float x[9];
};

/* 
*/

#define FIR_LEN 9

float fir_filter(struct fir *fir, float x)
{
	int i;
	float y = 0;

	fir->x[0] = x;
	for (i = 0; i < FIR_LEN; i++)
		y = y + fir->b[i] * fir->x[i];

	for (i = 1; i < FIR_LEN; i++)
		fir->x[(FIR_LEN - 1) - i + 1] = fir->x[(FIR_LEN - 1) - i]; 
	
	return y;
}

void filtfilt(struct fir *fir, float *dst, float *data, uint32_t len)
{
	int i;
	//float dd[1024];
	//float dd2[1024];

	for (i = 0; i < len ; i++) {
		dst[i] = fir_filter(fir, data[i]);	
	}
	i--;
	for (; i >= FIR_LEN ; i--) {
		dst[i] = fir_filter(fir, dst[i]);	
	}
	for (; i >= 0 ; i--) {
		dst[i] = fir_filter(fir, data[i]);	
	}
	for (i = 0; i < FIR_LEN ; i++) {
		dst[i] = fir_filter(fir, dst[i]);	
	}
	//memcpy(dst, dd2, len * sizeof(float));
}

int main(int argc, char *argv[])
{
	struct fir f;
	int i;
	uint32_t len;
	float dd2[4096];

	memset(&f, 0, sizeof(f));
	for (i = 0; i < FIR_LEN; i++) f.b[i] = 1.0 / FIR_LEN;
	len = sizeof(data) / sizeof(float);
	
	filtfilt(&f, dd2, data, len);
	for (i = 0; i < len; i++)
		printf("%d %f %f\n", i, data[i], dd2[i]);

	return 0;
}


